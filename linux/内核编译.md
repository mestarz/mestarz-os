- [1.1 QEMU运行内核](#11-qemu运行内核)
  - [1.1.1 编译内核](#111-编译内核)
    - [1.1.1.1 获取内核源码](#1111-获取内核源码)
    - [1.1.1.2 配置gcc版本](#1112-配置gcc版本)
    - [1.1.1.3 编译内核源码](#1113-编译内核源码)
  - [1.1.2 安装qemu](#112-安装qemu)
  - [1.1.3 制作磁盘镜像](#113-制作磁盘镜像)
    - [1.1.3.1 创建磁盘](#1131-创建磁盘)
    - [1.1.3.2 挂载磁盘镜像](#1132-挂载磁盘镜像)
    - [1.1.3.3 安装内核模块](#1133-安装内核模块)
    - [1.1.3.4 配置init程序](#1134-配置init程序)
  - [1.1.4 制作init程序](#114-制作init程序)
    - [1.1.4.1 编译busybox程序](#1141-编译busybox程序)
    - [1.1.4.2 安装busybox到磁盘镜像](#1142-安装busybox到磁盘镜像)
  - [1.1.5 qemu启动内核](#115-qemu启动内核)
  - [1.1.6 挂载文件系统](#116-挂载文件系统)
- [1.2 GDB、KGDB调试内核](#12-gdbkgdb调试内核)
- [1.3 树莓派运行内核](#13-树莓派运行内核)
> 参考网站 [https://www.cnblogs.com/hellogc/p/7482066.html](https://www.cnblogs.com/hellogc/p/7482066.html)

## 1.1 QEMU运行内核
### 1.1.1 编译内核
#### 1.1.1.1 获取内核源码
官方网站下载速度太慢，使用如下地址下载
> 第2位是偶数表示当前版本是稳定版
> 第2位是奇数表示当前版本是开发版，是内核开发过程中的一个快照
> 例如：5.8.xx是稳定版，5.9.xx是开发版
> 建议使用稳定版进行实验

```shell
http://ftp.sjtu.edu.cn/sites/ftp.kernel.org/pub/linux/kernel/
```
#### 1.1.1.2 配置gcc版本
安装需要的版本
```shell
sudo apt install gcc-7 gcc-7-multilib g++-7 g++-7-multilib
sudo apt install gcc-9 gcc-9-multilib g++-9 g++-9-multilib
```
设置优先级
```shell
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 60 --slave /usr/bin/g++ g++ /usr/bin/g++-7
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 90 --slave /usr/bin/g++ g++ /usr/bin/g++-9
```
切换gcc版本
```shell
sudo update-alternatives --config gcc
```


#### 1.1.1.3 编译内核源码
根据环境创建默认配置
```shell
make defconfig
```
编译程序
```shell
make   #可以使用make > /dev/null去掉返回信息
```
编译内核镜像
```shell
make bzImage
```
编译内核模块
```shell
make modules
```
### 1.1.2 安装qemu
```shell
sudo apt install qemu
sudo apt install qemu-system-x86_64
```
### 1.1.3 制作磁盘镜像
#### 1.1.3.1 创建磁盘
使用 `qemu-img` 创建一个512M的磁盘镜像文件      
```shell
qemu-img create -f raw disk.raw 512M
```
使用 `mkfs` 对磁盘镜像进行格式化
```shell
mkfs -t ext4 ./disk.raw
```
#### 1.1.3.2 挂载磁盘镜像
使用 `mount` 以loop方式将磁盘文件挂载到一个目录上
```shell
sudo mount -o loop ./disk.raw ./img
```
#### 1.1.3.3 安装内核模块
在linux源码目录下运行
```shell
sudo make modules_install \  #安装内核模块
INSTALL_MOD_PATH=./img		   #指定安装路径
```
#### 1.1.3.4 配置init程序
参考busybox[代码文档](https://git.busybox.net/busybox/tree/examples/inittab)可知，init启动后会扫描 `/etc/inittab` 配置文件，这个配置文件决定了init程序的行为。而busybox init在没有 `/etc/inittab` 文件的情况下也能工作，因为它有默认行为。它的默认行为相当于如下配置：
```shell
::sysinit:/etc/init.d/rcS
::askfirst:/bin/sh
::ctrlaltdel:/sbin/reboot
::shutdown:/sbin/swapoff -a
::shutdown:/bin/umount -a -r
::restart:/sbin/init
tty2::askfirst:/bin/sh
tty3::askfirst:/bin/sh
tty4::askfirst:/bin/sh
```
参考文档，进行如下操作
```shell
cd ./img
sudo mkdir ./etc
cd ./etc
sudo vim inittab
```
输入配置如下：
```shell
::sysinit:/etc/init.d/rcS
console::askfirst:-/bin/sh
::ctrlaltdel:/sbin/reboot
::shutdown:/sbin/swapoff -a
::shutdown:/bin/umount -a -r
::restart:/sbin/init
```
创建可执行文件 `/etc/init.d/rcS` 
```shell
cd ./img
sudo mkdir ./etc/init.d
cd ./etc/init.d
sudo vim rcS
sudo chmod 777 rcS
```
程序内容如下（空程序）：
```shell
#!/bin/sh
```
### 1.1.4 制作init程序
#### 1.1.4.1 编译busybox程序
下载busybox源码，进入源码目录，启用默认配置
```shell
make defconfig
```
使用菜单程序定制配置
```shell
make menuconfig
```
因为磁盘镜像中没有程序库，需要将busybox编译成一个独立、无依赖的可执行程序，窗口配置路径如下：
```shell
Settings --->
	--- Build Options
  [*] Build static binary (no shared libs)
```
配置完后执行编译
```shell
make
```
#### 1.1.4.2 安装busybox到磁盘镜像
```shell
make CONFIG_PREFIX=./img \  #磁盘文件的挂载路径
	install	
```
### 1.1.5 qemu启动内核
```shell
qemu-system-x86_64 \
    -m 512M \																#指定内存大小
    -smp 2 \    														#指定虚拟的CPU数量
    -kernel ./bzImage \											#指定内核文件路径
    -drive format=raw,file=./disk.raw \			#指定文件为磁盘
    -append "init=/linuxrc root=/dev/sda"		#内核启动参数
```
### 1.1.6 挂载文件系统
创建/dev，/proc，/sys目录
```shell
cd ./img
sudo mkdir ./dev
sudo mkdir ./proc
sudo mkdir ./sys
```
其中，/dev目录会在重启系统时自动挂载，/proc，/sys需要手动挂载，通过修改 `./etc/init.d/rcS` 文件使计算机自动挂载，修改 `./etc/init.d/rcS` 内容如下：
```shell
#!/bin/sh
mount -t proc proc /proc
mount -t sysfs sysfs /sys
```


## 1.2 GDB、KGDB调试内核
qemu参数说明<br />`-S    freeze CPU at startup (use 'c' to start execution)` <br />`-s    shorthand for -gdb tcp::1234` <br />
<br />

## 1.3 树莓派运行内核
> 参考网站：[https://blog.csdn.net/zxy131072/article/details/83545436](https://blog.csdn.net/zxy131072/article/details/83545436)
> [https://codechina.csdn.net/?utm_source=csdn_toolbar](https://codechina.csdn.net/?utm_source=csdn_toolbar)



